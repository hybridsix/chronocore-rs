<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ChronoCore — Settings & Devices</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Shared styles: base first, then operator look; spectator.css only if you reuse flag styles -->
<link rel="stylesheet" href="../css/base.css" />
<link rel="stylesheet" href="../css/operator.css" />

  <!-- Optional: if you want the same flag banner classes available here -->
  <!-- <link rel="stylesheet" href="/ui/css/spectator.css" /> -->
</head>
<body class="page settings">
  <header class="appHeader">
    <div class="brandRow">
      <div class="brand">
        <img src="../img/CCRS_Logo.svg" alt="ChronoCore Logo" class="logo" />
        <div class="brandText">
          <div class="brandTop">Chrono</div>
          <div class="brandBottom">Core</div>
          <div class="brandKicker">Race Software</div>
        </div>
      </div>
      <div class="headerRight">
        <!-- Show effective engine host so operators know what we’re talking to -->
        <div class="pill">
          <strong>Engine:</strong> <span id="engineHost">—</span>
        </div>
      </div>
    </div>
  </header>

  <main class="content content--narrow">
    <section class="card">
      <h2>Client Role</h2>
      <p class="muted">
        Choose how this station should behave. This setting is local to this device.
      </p>
      <div class="grid grid-2">
        <label class="stack">
          <span class="label">Role</span>
          <select id="role">
            <option value="operator">Operator (default)</option>
            <option value="spectator">Spectator</option>
            <option value="hybrid">Hybrid</option>
          </select>
        </label>
        <div class="stack">
          <span class="label">Notes</span>
          <div class="muted small">
            <ul class="tight">
              <li><b>Operator</b>: full control UI</li>
              <li><b>Spectator</b>: read-only leaderboard</li>
              <li><b>Hybrid</b>: both UIs available</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="row gap">
        <button id="btnSaveRole" class="btn">Save Role</button>
      </div>
    </section>

    <section class="card">
      <h2>Engine Host</h2>
      <p class="muted">
        The Operator UI talks to a running engine. Defaults come from <code>app.yaml</code> (<code>app.client.engine</code>).
        If overrides are allowed by policy, you can set a per-device host here.
      </p>

      <div class="grid grid-3">
        <label class="stack">
          <span class="label">Policy</span>
          <input id="policySummary" class="input" type="text" value="—" readonly />
          <span class="help small muted">From <code>app.yaml</code> (mode, same-origin, fixed host)</span>
        </label>

        <label class="stack">
          <span class="label">Effective Engine</span>
          <input id="effectiveHost" class="input" type="text" value="—" readonly />
          <span class="help small muted">Where this page is currently pointing</span>
        </label>

        <label class="stack">
          <span class="label">Override (per device)</span>
          <input id="engineInput" class="input" type="text" placeholder="host:port (e.g., 10.77.0.10:8000)" />
          <span id="overrideHelp" class="help small muted">Saved to this device only</span>
        </label>
      </div>

      <div class="row gap">
        <button id="btnTest" class="btn">Test Connection</button>
        <button id="btnSave" class="btn btn--primary">Save Override</button>
        <button id="btnClear" class="btn btn--subtle">Clear Override</button>
      </div>

      <div id="testResult" class="muted small" aria-live="polite"></div>
    </section>

    <section class="card">
      <h2>Quick Links</h2>
      <div class="row gap">
        <button id="gotoHome" class="btn">Operator Home</button>
        <button id="openSpectator" class="btn">Open Spectator View</button>
      </div>
    </section>
  </main>

  <footer class="appFooter">
    <div class="footerLeft">
      <span id="wallClock">--:--:--</span>
    </div>
    <div class="footerRight">
      <span id="netMsg" class="netMsg">Connecting…</span>
      <span id="netDot" class="netDot connecting" aria-label="Connecting…" title="Connecting…"></span>
    </div>
  </footer>

  <!-- Base helpers must be loaded before the inline script -->
  <script src="/ui/js/base.js"></script>

  <script>
    (function () {
      'use strict';

      const PRS = (window.PRS = window.PRS || {});
      const $ = PRS.$ || ((sel, root) => (root || document).querySelector(sel));

      // Cache important DOM elements
      const elRole         = $('#role');
      const btnSaveRole    = $('#btnSaveRole');

      const elPolicy       = $('#policySummary');
      const elEffective    = $('#effectiveHost');
      const elInput        = $('#engineInput');
      const elOverrideHelp = $('#overrideHelp');

      const btnTest        = $('#btnTest');
      const btnSave        = $('#btnSave');
      const btnClear       = $('#btnClear');
      const elTestResult   = $('#testResult');

      const elNetMsg       = $('#netMsg');
      const elNetDot       = $('#netDot');
      const elWallClock    = $('#wallClock');
      const elEngineHost   = $('#engineHost');

      document.addEventListener('DOMContentLoaded', init);
      // In some environments base.js may be loaded late; run init immediately too.
      init();

      function init() {
        // Start footer wall clock if available
        if (typeof PRS.startWallClock === 'function') {
          PRS.startWallClock(elWallClock);
        }

        // Show effective engine host for confidence
        if (elEngineHost && typeof PRS.effectiveEngineLabel === 'function') {
          elEngineHost.textContent = PRS.effectiveEngineLabel();
          elEngineHost.setAttribute('title', 'Effective Engine Host');
        }

        // Initialize role
        try {
          const savedRole = localStorage.getItem('cc.role');
          if (savedRole) elRole.value = savedRole;
        } catch {}

        // Initialize policy summary
        try {
          // These flags are exposed by base.js from app.yaml
          const mode = (PRS && PRS.PREFER_SAME_ORIGIN != null && PRS.ALLOW_OVERRIDE != null && PRS.EFFECTIVE_ENGINE != null)
            ? (window.PRS_BOOT && window.PRS_BOOT.app && window.PRS_BOOT.app.client && window.PRS_BOOT.app.client.engine && window.PRS_BOOT.app.client.engine.mode)
              || 'auto'
            : 'auto';

          const prefer = PRS.PREFER_SAME_ORIGIN ? 'same-origin ✓' : 'same-origin ✗';
          // We cannot know fixed_host safely without the bootstrap; display EFFECTIVE for clarity.
          const fixedInfo = (PRS.EFFECTIVE_ENGINE && PRS.EFFECTIVE_ENGINE !== 'same-origin' && PRS.EFFECTIVE_ENGINE !== '127.0.0.1:8000')
            ? `fixed-ish: ${PRS.EFFECTIVE_ENGINE}`
            : 'fixed: (see app.yaml)';

          elPolicy.value = `mode=${mode} | ${prefer} | ${fixedInfo}`;
        } catch {
          elPolicy.value = 'mode=auto | same-origin ✓';
        }

        // Effective engine string (read-only)
        if (elEffective && typeof PRS.effectiveEngineLabel === 'function') {
          elEffective.value = PRS.effectiveEngineLabel();
        }

        // Override field: honor allow/disallow from YAML
        if (!PRS.ALLOW_OVERRIDE) {
          elInput.value = '';
          elInput.readOnly = true;
          elInput.placeholder = 'Overrides disabled by policy (app.yaml)';
          elOverrideHelp.textContent = 'Overrides disabled by policy (app.yaml)';
          btnSave.disabled = true;
          btnClear.disabled = true;
        } else {
          // Load existing override if present
          try {
            const ov = localStorage.getItem('cc.engine_host') || '';
            elInput.value = ov;
          } catch {}
        }

        // Wire role save
        if (btnSaveRole) {
          btnSaveRole.addEventListener('click', () => {
            try {
              localStorage.setItem('cc.role', elRole.value);
              flashResult('Role saved.');
            } catch {
              flashResult('Unable to save role in this environment.');
            }
          });
        }

        // Wire Test Connection:
        // IMPORTANT: for testing we intentionally do NOT use PRS.url()
        // because the operator is testing the TYPED host, not the resolved one.
        if (btnTest) {
          btnTest.addEventListener('click', async () => {
            const candidate = (elInput.value || '').trim();
            if (!candidate) {
              flashResult('Enter a host:port to test.');
              return;
            }
            PRS.setNetStatus('connecting', elNetMsg, elNetDot);
            try {
              const u = /^https?:\/\//i.test(candidate)
                ? `${candidate.replace(/\/+$/, '')}/race/state`
                : `http://${candidate.replace(/\/+$/, '')}/race/state`;

              const r = await fetch(u, { cache: 'no-cache' });
              if (!r.ok) throw new Error(`HTTP ${r.status}`);
              const j = await r.json().catch(() => ({}));
              flashResult(`Connected: ${u} ${j && j.flag ? `(flag=${j.flag})` : ''}`);
              PRS.setNetStatus('ok', elNetMsg, elNetDot);
            } catch (e) {
              flashResult('Connection failed. Check host/IP, port, and network.');
              PRS.setNetStatus('disconnected', elNetMsg, elNetDot);
            }
          });
        }

        // Wire Save Override (only if allowed by policy)
        if (btnSave) {
          btnSave.addEventListener('click', () => {
            if (!PRS.ALLOW_OVERRIDE) return;
            const candidate = (elInput.value || '').trim();
            if (!candidate) {
              // Clearing override is via the Clear button
              flashResult('Nothing to save. Use Clear to remove an override.');
              return;
            }
            try {
              localStorage.setItem('cc.engine_host', candidate);
              flashResult('Override saved. Reload pages to apply.');
            } catch {
              flashResult('Unable to save override in this environment.');
            }
          });
        }

        // Wire Clear Override (only if allowed)
        if (btnClear) {
          btnClear.addEventListener('click', () => {
            if (!PRS.ALLOW_OVERRIDE) return;
            try {
              localStorage.removeItem('cc.engine_host');
              elInput.value = '';
              flashResult('Override cleared. Reload pages to apply.');
            } catch {
              flashResult('Unable to clear override in this environment.');
            }
          });
        }

        // Quick links
        $('#gotoHome')?.addEventListener('click', () => goto('/ui/operator/index.html'));
        $('#openSpectator')?.addEventListener('click', () => goto('/ui/spectator/spectator.html'));

        // Initial net state (we didn’t call the engine yet, but the page is ready)
        PRS.setNetStatus('ok', elNetMsg, elNetDot);
      }

      // Navigation: prefer pywebview bridge, then fall back to location.href
      function goto(path) {
        const href = typeof path === 'string' ? path : '/';
        if (window.pywebview && window.pywebview.api && typeof window.pywebview.api.goto === 'function') {
          try { window.pywebview.api.goto(href); return; } catch {}
        }
        location.href = href;
      }

      function flashResult(msg) {
        if (!msg) return;
        elTestResult.textContent = msg;
        elTestResult.classList.add('pulse');
        setTimeout(() => elTestResult.classList.remove('pulse'), 1200);
      }
    })();
  </script>
</body>
</html>

