<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>PRS — Spectator Leaderboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- CSS Styles-->
<link rel="stylesheet" href="/ui/css/base.css?v=1">  
<link rel="stylesheet" href="/ui/css/spectator.css?v=1">

<!-- Base Javascript Helpers-->
<script src="/ui/js/base.js?v=1"></script>

</head>
<body>
  <header>
    <div class="logo"><img src="img/PRS_Logo.svg" alt="PRS Logo" /></div>
    <div class="title">Live Timing — Spectator</div>
    <div class="raceclock-wrap">
      <div class="raceclock-label">Race&nbsp;Clock</div>
      <div class="pill pill-xl" id="raceClock" aria-live="polite" aria-label="Race clock">--:--</div>
    </div>

  </header>

  <main>

    <!-- Flag banner -->
    <div id="flagBanner" class="flag hidden" aria-live="polite">
      <div class="flag__icon" id="flagIcon" aria-hidden="true"></div>
      <div class="flag__label" id="flagLabel">Green Flag</div>
    </div>

    <section class="card">
      <h2>Leaderboard</h2>
      <div class="table">
        <div class="thead">
          <div>Position</div><div>Car #</div><div>Team</div>
          <div class="right">Laps</div><div class="right">Last Lap</div><div class="right">Best Lap</div>
        </div>
        <div class="rows" id="rows"></div>
      </div>
    </section>
  </main>

  <footer>
    <div class="footer-left">
      <div class="status-dot" id="netDot"></div>
      <div id="netMsg">Connecting…</div>
    </div>
        
      <div id="wallClock" class="pill">--:--:--</div>
    <div class="footer-right">
      <div style="margin-left:auto">API: <a class="link" href="/laps?limit=5" target="_blank">/laps</a></div>
    </div>
  </footer>

  <script>
  const { $, fetchJSON, makePoller, setNetStatus, startWallClock, fmtClock } = window.PRS;

  /* ----------- Wall clock ----------- */
  const stopWallClock = startWallClock("#wallClock");

  /* ----------- Update leaderboard table ----------- */
  function updateTable(data) {
    const rowsEl = $(".rows");
    if (!rowsEl) return;

    rowsEl.innerHTML = "";

    if (!data || !Array.isArray(data.rows)) return;

    data.rows.forEach((row, idx) => {
      const el = document.createElement("div");
      el.className = "row";

      const pos = idx + 1;
      const carNum = row.car || "";
      const teamName = row.team || `Tag ${row.tag}`;
      const laps = row.laps ?? 0;
      const last = row.last ? row.last.toFixed(3) : "—";
      const best = row.best ? row.best.toFixed(3) : "—";

      el.innerHTML = `
        <div>${pos}</div>
        <div class="car">${carNum}</div>
        <div class="name">${teamName}</div>
        <div class="right">${laps}</div>
        <div class="right">${last}</div>
        <div class="right best">${best}</div>
      `;
      rowsEl.appendChild(el);
    });
  }

  /* ----------- Flag banner ----------- */
  function updateFlagBanner(flag) {
    const banner = $(".flag");
    const label = $(".flag__label");
    if (!banner || !label) return;

    banner.className = "flag"; // reset classes
    if (!flag) {
      banner.classList.add("hidden");
      label.textContent = "";
      return;
    }
    banner.classList.remove("hidden");
    banner.classList.add(`flag--${flag}`);
    label.textContent = flag.toUpperCase();
  }

  /* ----------- Pollers ----------- */

  // Laps/leaderboard
  const lapsPoller = makePoller(async () => {
    const data = await fetchJSON("/laps?limit=200");
    updateTable(data);
    const rows = Array.isArray(data?.rows) ? data.rows.length : (data?.length ?? 0);
    setNetStatus(true, `OK — ${rows} rows`);
  }, 1000, () => setNetStatus(false, "Disconnected — retrying..."));

  // Race state (flag + race clock)
  const racePoller = makePoller(async () => {
    const s = await fetchJSON("/race/state");
    updateFlagBanner(s.flag);
    const el = $("#raceClock");
    el.textContent = s.clock_ms == null ? "--:--" : fmtClock(s.clock_ms);
  }, 1000, () => {
    const el = $("#raceClock");
    if (el) el.textContent = "--:--";
  });

  /* ----------- Start polling ----------- */
  lapsPoller.start();
  racePoller.start();
</script>
  
 </body>
</html>
