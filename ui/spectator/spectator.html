<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ChronoCore — Spectator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Styles (unchanged layout/tokens) -->
  <link rel="stylesheet" href="/ui/css/base.css?v=1">
  <link rel="stylesheet" href="/ui/css/spectator.css?v=1">

  <!-- Helpers (fetchJSON, makePoller, setNetStatus, startWallClock, fmtClock) -->
  <script src="/ui/js/base.js?v=1"></script>
</head>
<body>
  <header>
    <div class="logo"><img src="/ui/img/PRS_Logo.svg" alt="PRS Logo" /></div>
    <div class="title">Live Timing — Spectator</div>
    <div class="raceclock-wrap">
      <div class="raceclock-label">Race&nbsp;Clock</div>
      <div class="pill pill-xl" id="raceClock" aria-live="polite" aria-label="Race clock">--:--</div>
    </div>
  </header>

  <main>
    <!-- Flag banner (class is switched to flag--{color}) -->
    <div id="flagBanner" class="flag hidden" aria-live="polite">
      <div class="flag__icon" id="flagIcon" aria-hidden="true"></div>
      <div class="flag__label" id="flagLabel">—</div>
    </div>

    <section class="card">
      <h2>Leaderboard</h2>
      <div class="table">
        <div class="thead">
          <div>Position</div><div>Car #</div><div>Team</div>
          <div class="right">Laps</div><div class="right">Last Lap</div><div class="right">Best Lap</div>
        </div>
        <div class="rows" id="rows"></div>
      </div>
    </section>
  </main>

  <footer>
    <div class="footer-left">
      <div class="status-dot" id="netDot"></div>
      <div id="netMsg">Connecting…</div>
    </div>

    <div id="wallClock" class="pill">--:--:--</div>

    <div class="footer-right">
      API: <a class="link" href="/race/state" target="_blank">/race/state</a>
    </div>
  </footer>

  <script>
    // Pull helpers from base.js (already loaded)
    const { $, fetchJSON, makePoller, setNetStatus, startWallClock, fmtClock } = window.PRS || {};

    /* ---------- Footer wall clock ---------- */
    const stopWallClock = startWallClock("#wallClock");

    /* ---------- Render functions ---------- */

    function renderClock(clock_ms) {
      const el = $("#raceClock");
      el.textContent = (clock_ms == null) ? "--:--" : fmtClock(clock_ms);
    }

    function renderFlag(flag) {
      const banner = $("#flagBanner");
      const label  = $("#flagLabel");
      if (!banner || !label) return;

      banner.className = "flag";          // reset base styles
      if (!flag) {                        // hide if engine gives null/undefined
        banner.classList.add("hidden");
        label.textContent = "";
        return;
      }
      label.textContent = flag.toUpperCase();
      banner.classList.remove("hidden");
      banner.classList.add(`flag--${flag}`);
    }

    function renderStandings(rows) {
      const rowsEl = $("#rows");
      if (!rowsEl) return;
      rowsEl.innerHTML = "";

      if (!Array.isArray(rows) || !rows.length) return;

      rows.forEach((r, i) => {
        const el = document.createElement("div");
        el.className = "row";

        // Map required fields; fall back defensively if the engine varies keys
        const pos   = i + 1;
        const car   = r.car_number ?? r.car ?? r.carNum ?? "";
        const name  = r.name ?? r.team ?? r.driver ?? `Tag ${r.tag ?? ""}`;
        const laps  = r.laps ?? 0;
        const last  = (typeof r.last === "number") ? r.last.toFixed(3) : "—";
        const best  = (typeof r.best === "number") ? r.best.toFixed(3) : "—";
        // pace_5 is available from the engine but not displayed in this minimal table

        el.innerHTML = `
          <div>${pos}</div>
          <div class="car">${car}</div>
          <div class="name">${name}</div>
          <div class="right">${laps}</div>
          <div class="right">${last}</div>
          <div class="right best">${best}</div>
        `;
        rowsEl.appendChild(el);
      });
    }

    /* ---------- Single poller: /race/state (engine-first, 3 Hz) ---------- */

    // Accept a few plausible shapes from the engine: {standings:[...]}, {entries:[...]}, or {rows:[...]}
    function extractRows(state) {
      return state?.standings ?? state?.entries ?? state?.rows ?? [];
    }

    const pollIntervalMs = 333; // ≈3 Hz within the requested 2–5 Hz

    const statePoller = makePoller(async () => {
      const s = await fetchJSON("/race/state");

      // Clock + flag from authoritative engine state
      renderClock(s.clock_ms);
      renderFlag(s.flag);

      // Standings table
      const rows = extractRows(s);
      renderStandings(rows);

      // Footer net status
      setNetStatus(true, `OK — ${rows.length} karts`);
    }, pollIntervalMs, () => {
      setNetStatus(false, "Disconnected — retrying…");
      renderClock(null);
    });

    statePoller.start();
  </script>
</body>
</html>
