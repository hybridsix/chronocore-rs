<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ChronoCore — Spectator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Your real styles -->
  <link rel="stylesheet" href="/ui/css/base.css?v=1">
  <link rel="stylesheet" href="/ui/css/spectator.css?v=1">

  <!-- Helpers; page ships tiny shims if this isn't present -->
  <script src="/ui/js/base.js?v=1" defer></script>
</head>
<body>
  <header>
    <div class="logo">
      <img src="/ui/img/PRS_Logo.svg" alt="PRS Logo"
           onerror="this.onerror=null;this.src='/ui/PRS_Logo.svg'">
    </div>
    <div class="title">Live Timing — Spectator</div>
    <!-- Simulator status pill (hidden until state arrives) -->
    <div class="sim-wrap">
  <div class="pill hidden" id="simPill">SIMULATOR ACTIVE</div>
    </div>
    <div class="raceclock-wrap">
      <div class="raceclock-label">Race&nbsp;Clock</div>
  <div class="pill pill-xl" id="raceClock">--:--</div>
    </div>
  </header>

  <main>
    <!-- Flag banner -->
    <div id="flagBanner" class="flag hidden">
      <div class="flag__icon"></div>
      <div class="flag__label" id="flagLabel">—</div>
    </div>

    <section class="card">
      <h2>Leaderboard</h2>
      <div class="table">
        <div class="thead">
          <div>Position</div><div>Car #</div><div>Team</div>
          <div class="right">Laps</div><div class="right">Last Lap</div><div class="right">Best Lap</div>
        </div>
        <div class="rows" id="rows"></div>
      </div>
    </section>
  </main>

  <footer>
    <div class="footer-left">
      <div class="status-dot" id="netDot"></div>
      <div id="netMsg">Connecting…</div>
    </div>
    <div id="wallClock" class="pill">--:--:--</div>
    <div class="footer-right">API: <a class="link" href="/race/state" target="_blank">/race/state</a></div>
  </footer>

  <script>
    // --- Minimal shims if /ui/js/base.js isn't around -----------------------
    (function () {
  if (window.CCRS && typeof window.CCRS.fetchJSON === "function") return;
      const $ = (s)=>document.querySelector(s);
      async function fetchJSON(url){ const r=await fetch(url,{cache:"no-store"}); if(!r.ok) throw new Error(r.status); return r.json(); }
      function makePoller(fn,ms,onErr){ let t=null; const tick=async()=>{ try{await fn();}catch(e){onErr&&onErr(e);} finally{ t=setTimeout(tick,ms);} }; return { start(){ if(!t) tick(); }, stop(){ if(t) clearTimeout(t); t=null; } }; }
      function setNetStatus(ok,msg){ const d=$("#netDot"), m=$("#netMsg"); if(d) d.style.background = ok ? "var(--ok)" : "var(--error)"; if(m) m.textContent = msg || (ok?"OK":"Disconnected"); }
      function fmtClock(ms){
        if(ms==null) return "--:--";
        const s=Math.max(0,Math.floor(ms/1000));
        const m=Math.floor(s/60), ss=s%60;
        return `${String(m).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;
      }
      function startWallClock(sel){ const el=$(sel); const up=()=>{ const d=new Date(); el.textContent = `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}:${String(d.getSeconds()).padStart(2,"0")}`; }; up(); const id=setInterval(up,1000); return ()=>clearInterval(id); }
      window.CCRS = { $, fetchJSON, makePoller, setNetStatus, fmtClock, startWallClock };
    })();

    const { $, fetchJSON, makePoller, setNetStatus, fmtClock, startWallClock } = window.CCRS;

    // Human-friendly flag titles (use hyphen, not em-dash)
    const FLAG_TITLES = {
      pre:       "Pre - Staging",
      green:     "Green - Race On",
      yellow:    "Yellow - Caution",
      red:       "Red - Race Stopped",
      white:     "White - Final Lap",
      checkered: "Checkered - Finish",
      blue:      "Blue - Driver Swap"
    };

    // Footer wall clock
    startWallClock("#wallClock");

    // --- Smooth race clock state -------------------------------------------
    let running = false;
    let lastSnapTime = 0;  // ms (Date.now()) when snapshot arrived
    let lastClockMs  = 0;  // snapshot.clock_ms at that moment

    function renderClockTick(){
      let ms = lastClockMs;
      if (running) ms += (Date.now() - lastSnapTime);
      $("#raceClock").textContent = fmtClock(ms);
    }

    function renderFlag(flag) {
      const host = document.querySelector('#flagBanner');
      const lbl  = document.querySelector('#flagLabel');
      if (!host || !lbl) return;

      const f = String(flag || '').toLowerCase();

      if (!f) {
        host.className = 'flag hidden';
        host.dataset.currentFlag = '';
        lbl.textContent = '';
        host.removeAttribute('title');
        return;
      }

      const prev = host.dataset.currentFlag || '';
      host.className = `flag flag--${f}`;

      const pulsing = new Set(['yellow','red','blue','checkered']);
      if (pulsing.has(f)) host.classList.add('is-pulsing'); else host.classList.remove('is-pulsing');

      if (f === 'green' && prev !== 'green') {
        host.classList.remove('flash'); void host.offsetWidth;
        host.classList.add('flash');
        host.addEventListener('animationend', (e) => {
          if (e.animationName === 'greenFlash') host.classList.remove('flash');
        }, { once: true });
      } else if (f !== 'green') {
        host.classList.remove('flash');
      }

      const text = FLAG_TITLES[f] || (f.charAt(0).toUpperCase() + f.slice(1));
      lbl.textContent = text;
  host.setAttribute('title', text);
      host.dataset.currentFlag = f;
    }

    function renderStandings(rows) {
      const rowsEl = $("#rows");
      rowsEl.innerHTML = "";
      if (!Array.isArray(rows) || !rows.length) return;

      rows.forEach((r, i) => {
        const el = document.createElement("div");
        el.className = "row";
        const pos   = i + 1;
  const car   = r.number ?? r.car ?? r.carNum ?? "";
        const name  = r.name ?? r.team ?? r.driver ?? `Tag ${r.tag ?? ""}`;
        const laps  = r.laps ?? 0;
        const last  = (typeof r.last === "number") ? r.last.toFixed(3) : "—";
        const best  = (typeof r.best === "number") ? r.best.toFixed(3) : "—";
        el.innerHTML = `
          <div>${pos}</div>
          <div class="car">${car}</div>
          <div class="name">${name}</div>
          <div class="right">${laps}</div>
          <div class="right">${last}</div>
          <div class="right best">${best}</div>`;
        rowsEl.appendChild(el);
      });
    }

    function renderSim(sim, label) {
      const el = document.querySelector('#simPill');
      if (!el) return;
      const on = (sim === true);
      if (on) {
        el.textContent = label && String(label).trim().length ? label : "SIMULATOR ACTIVE";
        el.title = el.textContent;
        el.classList.remove('hidden');
        el.classList.add('pulsing');
      } else {
        el.classList.add('hidden');
        el.classList.remove('pulsing');
        el.textContent = "";
        el.removeAttribute('title');
      }
    }

    // Poll /race/state at ~3 Hz and tick clock locally at 10 Hz
    function extractRows(s){ return s?.standings ?? s?.entries ?? s?.rows ?? []; }
    const poller = makePoller(async () => {
      const s = await fetchJSON("/race/state");

      // Update smooth clock state
      running      = !!s.running;
      lastClockMs  = s.clock_ms || 0;
      lastSnapTime = Date.now();

      renderFlag(s.flag);
      renderStandings(extractRows(s));
      renderSim(s.sim, s.sim_label);

      const n = Array.isArray(s?.standings) ? s.standings.length : 0;
      setNetStatus(true, `OK — ${n} karts`);
    }, 333, () => {
      setNetStatus(false, "Disconnected — retrying…");
      // Keep last good clock rendered; don't blank it here
    });
    poller.start();

    // Local clock ticker
    setInterval(renderClockTick, 100);

    // Initial placeholder render
    renderClockTick();
  </script>
</body>
</html>
