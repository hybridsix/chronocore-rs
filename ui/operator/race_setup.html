<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>CCRS — Race Setup</title>

    <!-- Shared styles -->
    <link rel="stylesheet" href="/ui/css/base.css" />
    <link rel="stylesheet" href="/ui/css/operator.css" />

    <!-- Page-specific styles -->
    <link rel="stylesheet" href="/ui/css/race_setup_new.css" />

    <!-- Shared JS -->
    <script src="../js/base.js" defer></script>
    <!-- Page controller -->
    <script src="../js/race_setup.js" defer></script>
  </head>

  <body class="race-setup">
    <!-- =============================================================
         HEADER — identical structure to Diagnostics (icons.svg + app-nav)
    ============================================================= -->
    <header class="app-header">
      <div class="brand">
        <a class="brand-link" href="/ui/operator/index.html" aria-label="Go to Home">
          <img class="brand-logo" src="../img/CCRS_Logo.svg" alt="CCRS Logo" />
          <div class="brand__wordmark" aria-label="ChronoCore Race Software">
            <div class="wordmark__top">
              <span class="wordmark__big">CHRONO</span>
              <span class="wordmark__big">CORE</span>
            </div>
            <div class="wordmark__bottom">RACE SOFTWARE</div>
          </div>
        </a>

        <div class="page-label">Race Setup</div>
      </div>

      <div class="app-header__tools">
        <nav class="app-nav" aria-label="Site navigation">
          <a class="app-nav__link" href="/ui/operator/index.html" aria-label="Home" title="Home">
            <svg class="icon" aria-hidden="true"><use href="../img/icons.svg#home"></use></svg>
            <span class="sr-only">Home</span>
          </a>

          <div class="app-nav__menu" id="appsMenu" data-open="false">
            <button type="button" class="app-nav__btn" aria-haspopup="true" aria-expanded="false" aria-controls="appsPanel" title="Menu">
              <svg class="icon" aria-hidden="true"><use href="../img/icons.svg#menu"></use></svg>
              <span class="sr-only">Open menu</span>
            </button>
            <div class="app-nav__panel" id="appsPanel" role="menu" aria-labelledby="appsMenu">
              <a href="/ui/operator/entrants.html" role="menuitem">Entrants &amp; Tags</a>
              <a href="/ui/operator/operator.html" role="menuitem">Operator</a>
              <a href="/ui/operator/settings.html" role="menuitem">Settings</a>
              <a href="/ui/operator/diag.html" role="menuitem">Diagnostics</a>
              <a href="/ui/operator/help.html" role="menuitem">Help</a>
            </div>
          </div>
        </nav>
      </div>
    </header>

    <!-- =============================================================
         MAIN CONTENT
    ============================================================= -->
    <main class="wrap" role="main" aria-label="Race Setup">
      <section class="page-body" aria-label="Content">
        <form id="raceForm" class="rs-grid" autocomplete="off">
          <!-- ===== LEFT: Event / Mode ===== -->
          <section class="card rs-card" aria-label="Event and Mode">
            <h2 class="card__title">Event &amp; Mode</h2>

            <div class="field">
              <label class="label" for="eventLabel">Event Label</label>
              <input id="eventLabel" name="event_label" class="input" type="text"
                     placeholder="Maker Faire Orlando 2025" />
            </div>

            <div class="field">
              <label class="label" for="sessionLabel">Session Label</label>
              <input id="sessionLabel" name="session_label" class="input" type="text"
                     placeholder="Sprint 2" />
            </div>

            <div class="field">
              <label class="label" for="modeSelect">Mode</label>
              <select id="modeSelect" name="mode_id" class="input">
                <!-- options populated by JS; last option is Custom -->
              </select>
              <div class="hint">Built-in presets from race_modes.yaml. Choose <strong>Custom</strong> to define a new one.</div>
            </div>

            <!-- Custom mode save UI (revealed only when Custom is selected) -->
            <div id="customSave" class="field">
              <label class="label" for="customLabel">Save as new mode</label>
              <div class="row">
                <input id="customLabel" class="input medium" type="text"
                      placeholder="Mode name (shown in menu)" />
                <button type="button" id="btnSaveMode" class="btn btn-primary">Save</button>
              </div>
              <div class="hint">
                Uses the name to create an ID (e.g., “Night Sprint” → <code>night-sprint</code>).
                If that mode already exists, you'll be asked to confirm overwrite.
              </div>
            </div>

          </section>

          <!-- ===== CENTER: Timing & Scoring ===== -->
          <section class="card rs-card" aria-label="Timing and Scoring">
            <h2 class="card__title">Timing &amp; Scoring</h2>

            <!-- Limit choice (time | laps) -->
            <fieldset class="field">
              <legend class="label">Limit</legend>
              <div class="row">
                <label class="radio">
                  <input type="radio" name="limit_type" value="time" id="limitTime">
                  <span>Time</span>
                </label>
                <label class="radio">
                  <input type="radio" name="limit_type" value="laps" id="limitLaps">
                  <span>Laps</span>
                </label>
              </div>

              <!-- Time inputs -->
              <!-- Laps input (always visible; disabled when Limit=Time) -->
              <div class="row" id="rowLapsValue">
                <label class="sub label-col" for="limitValueLaps">Laps</label>
                <input id="limitValueLaps" name="limit_value_laps"
                      class="input small" type="number" min="1" step="1" value="10" />
              </div>

              <!-- Duration in minutes (always visible; disabled when Limit=Laps) -->
              <div class="row" id="rowTimeValue">
                <label class="sub label-col" for="limitValueS">Duration (min)</label>
                <input id="limitValueS" name="limit_value_s"
                      class="input small" type="number" min="0" step="1" value="900" />
                <span class="sub">0 = unlimited</span>
              </div>

              <!-- Soft end (time-only; we grey/disable when it doesn’t apply) -->
              <div class="row" id="rowSoftEnd">
                <label class="sub label-col" for="limitSoftEnd">Soft end</label>
                <label class="checkbox">
                  <input id="limitSoftEnd" type="checkbox" />
                  <span class="sub">Do not auto-stop at expiry</span>
                </label>
              </div>
            </fieldset>

            <!-- Rank method -->
            <div class="field">
              <label class="label" for="rankMethod">Rank method</label>
              <select id="rankMethod" name="rank_method" class="input">
                <option value="total_laps">Total Laps</option>
                <option value="best_lap">Best Lap</option>
              </select>
            </div>

            <!-- Min lap filter -->
            <div class="field">
              <label class="label" for="minLapS">Minimum Lap (s)</label>
              <input id="minLapS" name="min_lap_s" class="input small" type="number" min="0" step="0.1" value="4.1" />
              <div class="hint">Reject laps faster than this to prevent double-reads.</div>
            </div>

            <!-- Countdowns -->
            <fieldset class="field">
              <legend class="label">Countdowns</legend>
              <div class="row">
                <label class="checkbox">
                  <input id="startEnabled" type="checkbox" />
                  <span>Start countdown</span>
                </label>
                <label class="sub" for="startFromS">from</label>
                <input id="startFromS" class="input small" type="number" min="1" step="1" value="10" />
              </div>
              <div class="row">
                <label class="checkbox">
                  <input id="endEnabled" type="checkbox" />
                  <span>End countdown</span>
                </label>
                <label class="sub" for="endFromS">from</label>
                <input id="endFromS" class="input small" type="number" min="1" step="1" value="10" />
              </div>
              <div class="row">
                <label class="sub" for="timeoutS">Timeout padding (s)</label>
                <input id="timeoutS" class="input small" type="number" min="0" step="1" value="0" />
              </div>
            </fieldset>
          </section>

          <!-- ===== RIGHT: Comms & Announcements ===== -->
          <section class="card rs-card" aria-label="Comms and Announcements">
            <h2 class="card__title">Comms &amp; Announcements</h2>

            <div class="field">
              <label class="label" for="lapIndication">Lap indication</label>
              <select id="lapIndication" class="input">
                <option value="none">None</option>
                <option value="beep">Beep</option>
                <option value="tts">TTS short</option>
              </select>
            </div>

            <fieldset class="field">
              <legend class="label">Rank announcements</legend>
              <div class="row">
                <label class="checkbox">
                  <input id="rankEnabled" type="checkbox" />
                  <span>Enabled</span>
                </label>
                <label class="sub" for="rankInterval">every</label>
                <input id="rankInterval" class="input small" type="number" min="1" step="1" value="4" />
                <span class="sub">laps</span>
              </div>
              <div class="row">
                <label class="checkbox">
                  <input id="rankChangeSpeech" type="checkbox" />
                  <span>Announce rank changes</span>
                </label>
              </div>
              <div class="row">
                <label class="checkbox">
                  <input id="bestLapSpeech" type="checkbox" />
                  <span>Announce best laps</span>
                </label>
              </div>
            </fieldset>

            <div class="divider"></div>

            <div class="field">
              <div class="row">
                <button type="button" id="btnTestBeep" class="btn">Test Beep</button>
                <button type="button" id="btnTestHorn" class="btn">Test Horn</button>
              </div>
              <div class="hint">Quick audio sanity check for the ops desk.</div>
            </div>

           <div class="divider"></div>

            <div class="field">
              <label class="checkbox">
                <input id="decoderBypass" type="checkbox" />
                <span class="sub">Decoder bypass (allow start without decoders)</span>
              </label>
            </div>
          </section>
        </form>

        <!-- Sticky action row -->
        <div class="sticky-row" role="region" aria-label="Race controls">
          <div class="summary"><span id="summaryText">—</span></div>
          <div class="readiness">
            <span class="chip" id="chipDB">DB: —</span>
            <span class="chip" id="chipDecoder">Decoder: —</span>
            <span class="chip" id="chipEntrants">Entrants: —</span>
          </div>
          <div class="actions">
            <button type="button" class="btn btn--ghost" id="btnSaveConfig">Save Config</button>
            <button type="button" class="btn btn--primary" id="btnStartRace">Start Race</button>
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="app-footer">
      <div class="footer-left">
        <div class="status-dot" id="netDot"></div>
        <div id="netMsg">Ready</div>
      </div>
      <div class="footer-center">
        <div class="pill pill--db" id="readyPill" aria-live="polite" hidden>DB: ready</div>
        <div class="pill pill--db" id="engineLabel" aria-live="polite" hidden>Engine: —</div>
      </div>
      <div class="footer-right"></div>
    </footer>

    <script>
      // Reuse the same small dropdown controller as Diagnostics
      (function () {
        const menu = document.getElementById('appsMenu');
        if (!menu) return;
        const btn   = menu.querySelector('.app-nav__btn');
        const panel = menu.querySelector('.app-nav__panel');
        function openMenu(on) {
          menu.dataset.open = on ? 'true' : 'false';
          btn.setAttribute('aria-expanded', on ? 'true' : 'false');
        }
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          openMenu(menu.dataset.open !== 'true');
          if (menu.dataset.open === 'true') {
            const first = panel.querySelector('a');
            if (first) first.focus();
          }
        });
        document.addEventListener('click', () => openMenu(false));
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') openMenu(false); });
        panel.addEventListener('keydown', (e) => {
          const items = Array.from(panel.querySelectorAll('a'));
          const i = items.indexOf(document.activeElement);
          if (e.key === 'ArrowDown') { e.preventDefault(); (items[i + 1] || items[0]).focus(); }
          else if (e.key === 'ArrowUp') { e.preventDefault(); (items[i - 1] || items[items.length - 1]).focus(); }
          else if (e.key === 'Home') { e.preventDefault(); (items[0] || document.activeElement).focus(); }
          else if (e.key === 'End') { e.preventDefault(); (items[items.length - 1] || document.activeElement).focus(); }
        });
      })();
    </script>
  </body>
</html>
