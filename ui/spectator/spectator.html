<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ChronoCore - Spectator</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap only -->
  <link rel="stylesheet" href="/ui/css/bootstrap.min.css" />

  <!-- Helpers; page ships tiny shims if this isn't present -->
  <script src="/ui/js/base.js?v=1" defer></script>
</head>

<body class="min-vh-100 d-flex flex-column">

  <!-- ================= HEADER ================= -->
  <header class="border-bottom">
    <div class="container-fluid py-2">
      <div class="d-flex flex-wrap align-items-center gap-3">

        <!-- Brand -->
        <div class="d-flex align-items-center gap-2">
          <img src="/ui/img/PRS_Logo.svg" alt="PRS Logo" height="36"
               onerror="this.onerror=null;this.src='/ui/PRS_Logo.svg'">
          <div class="fw-semibold">Live Timing - Spectator</div>
        </div>

        <!-- Race info -->
        <span class="badge text-bg-secondary ms-0 ms-md-2" id="raceInfo">-</span>

        <!-- Sim pill -->
        <span class="badge text-bg-warning d-none" id="simPill">SIMULATOR ACTIVE</span>

        <!-- Race clock (right aligned) -->
        <div class="ms-auto d-flex align-items-center gap-2">
          <div class="text-body-secondary small">Race Clock</div>
          <span class="badge text-bg-secondary fs-6 font-monospace px-3 py-2" id="raceClock">--:--</span>
        </div>
        <!-- Theme toggle (theme-aware button; no outline-light) -->
        <button id="themeToggle" type="button" class="btn btn-sm btn-outline-secondary ms-2"
          title="Toggle light/dark theme" aria-label="Toggle theme">
          ðŸŒ™
        </button>
      </div>
    </div>
  </header>

  <!-- ================= MAIN ================= -->
  <main class="container-fluid py-3 flex-grow-1">

    <!-- Flag banner -->
    <div id="flagBanner" class="alert alert-secondary d-none py-2" role="status">
      <div class="fw-semibold" id="flagLabel">-</div>
    </div>

    <section class="card border-secondary">
      <div class="card-header border-secondary d-flex align-items-center justify-content-between">
        <h2 class="h5 mb-0">Leaderboard</h2>
        <span class="text-body-secondary small">Top 16</span>
      </div>

      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead>
            <tr>
              <th scope="col">Position</th>
              <th scope="col">Car #</th>
              <th scope="col">Team</th>
              <th scope="col" class="text-start">Laps</th>
              <th scope="col" class="text-start">Last Lap</th>
              <th scope="col" class="text-start">Pace</th>
              <th scope="col" class="text-start">Best Lap</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>
  </main>

  <!-- ================= FOOTER ================= -->
  <footer class="mt-auto border-top">
    <div class="container-fluid py-2">
      <div class="row align-items-center text-center">
        <div class="col d-flex align-items-center gap-2 justify-content-start">
          <span class="badge text-bg-secondary" id="netDot">â€¢</span>
          <span id="netMsg" class="text-body-secondary">Connectingâ€¦</span>
        </div>

        <div class="col">
          <span id="wallClock" class="badge text-bg-secondary font-monospace">--:--:--</span>
        </div>

        <div class="col d-flex justify-content-end">
          <span class="text-body-secondary small">
            API:
            <a class="link-light" href="/race/state" target="_blank" rel="noopener">/race/state</a>
          </span>
        </div>
      </div>
    </div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="/ui/js/bootstrap.bundle.min.js"></script>

  <script>
    // --- Minimal shims if /ui/js/base.js isn't around -----------------------
    (function () {
      if (window.CCRS && typeof window.CCRS.fetchJSON === "function") return;

      const $ = (s)=>document.querySelector(s);
      async function fetchJSON(url){
        const r = await fetch(url, { cache:"no-store" });
        if(!r.ok) throw new Error(r.status);
        return r.json();
      }
      function makePoller(fn,ms,onErr){
        let t=null;
        const tick=async()=>{
          try{ await fn(); }
          catch(e){ onErr && onErr(e); }
          finally{ t=setTimeout(tick,ms); }
        };
        return { start(){ if(!t) tick(); }, stop(){ if(t) clearTimeout(t); t=null; } };
      }
      function setNetStatus(ok,msg){
        const dot = $("#netDot"), m = $("#netMsg");
        if(dot) dot.className = ok ? "badge text-bg-success" : "badge text-bg-danger";
        if(m) m.textContent = msg || (ok ? "OK" : "Disconnected");
      }
      function fmtClock(ms){
        if(ms==null) return "--:--";
        const s=Math.max(0,Math.floor(ms/1000));
        const m=Math.floor(s/60), ss=s%60;
        return `${String(m).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;
      }
      function startWallClock(sel){
        const el = $(sel);
        if(!el) return ()=>{};
        const up=()=>{
          const d=new Date();
          el.textContent = `${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}:${String(d.getSeconds()).padStart(2,"0")}`;
        };
        up();
        const id=setInterval(up,1000);
        return ()=>clearInterval(id);
      }
      window.CCRS = { $, fetchJSON, makePoller, setNetStatus, fmtClock, startWallClock };
    })();

    const { $, fetchJSON, makePoller, setNetStatus, fmtClock, startWallClock } = window.CCRS;

    // Human-friendly flag titles (use hyphen, not em-dash)
    const FLAG_TITLES = {
      pre:       "Pre - Staging",
      green:     "Green - Race On",
      yellow:    "Yellow - Caution",
      red:       "Red - Race Stopped",
      white:     "White - Final Lap",
      checkered: "Checkered - Finish",
      blue:      "Blue - Driver Swap"
    };

    const PRELAP_PLACEHOLDER = "--:--.---";
    const DETECTION_PHASES = new Set(["green", "white", "yellow", "red", "blue", "checkered"]);
    const zeroLapDetections = new Set();
    const seenCountSnapshot = new Map();
    let lastPhaseForDetections = null;

    const bestLapTracker = new Map(); // entrant_id -> best lap time (sec)

    function refreshSeenBaseline(rows) {
      seenCountSnapshot.clear();
      if (!Array.isArray(rows)) return;
      for (const row of rows) {
        const id = Number(row?.entrant_id);
        if (!Number.isFinite(id)) continue;
        const reads = Math.max(0, Number(row?.reads ?? 0));
        seenCountSnapshot.set(id, reads);
      }
    }

    function updateZeroLapDetections(state, phaseLower) {
      const rows = Array.isArray(state?.seen?.rows) ? state.seen.rows : [];
      const activePhase = DETECTION_PHASES.has(phaseLower);

      if (!activePhase) {
        zeroLapDetections.clear();
        refreshSeenBaseline(rows);
        lastPhaseForDetections = phaseLower;
        return;
      }

      if (!DETECTION_PHASES.has(lastPhaseForDetections)) {
        zeroLapDetections.clear();
        if (seenCountSnapshot.size === 0) refreshSeenBaseline(rows);
      }

      lastPhaseForDetections = phaseLower;

      for (const row of rows) {
        const id = Number(row?.entrant_id);
        if (!Number.isFinite(id)) continue;
        const reads = Math.max(0, Number(row?.reads ?? 0));
        const prev = seenCountSnapshot.get(id);

        if (prev === undefined) {
          if (reads > 0) zeroLapDetections.add(id);
        } else if (reads > prev) {
          zeroLapDetections.add(id);
        }
        seenCountSnapshot.set(id, reads);
      }
    }

    function fmtLapTime(sec) {
      if (sec == null) return "-";
      const ms = Math.round((sec - Math.floor(sec)) * 1000);
      const s  = Math.floor(sec) % 60;
      const m  = Math.floor(sec / 60);
      return `${m}:${String(s).padStart(2,'0')}.${String(ms).padStart(3,'0')}`;
    }

    function formatLimit(lim) {
      if (!lim || typeof lim !== "object") return null;
      const t = String(lim.type || "").toLowerCase();

      if (t === "time") {
        const seconds = (lim.value_s != null) ? Number(lim.value_s)
                      : (lim.value    != null) ? Number(lim.value)
                      : null;
        if (Number.isFinite(seconds) && seconds > 0) {
          const minutes = Math.floor(seconds / 60);
          return `Time ${minutes}m`;
        }
        if (seconds === 0) return "Unlimited";
      } else if (t === "laps") {
        const laps = (lim.value_laps != null) ? Number(lim.value_laps)
                  : (lim.value       != null) ? Number(lim.value)
                  : null;
        if (Number.isFinite(laps)) return `Laps ${laps}`;
      }
      return null;
    }

    function renderRaceInfo(state) {
      const el = document.getElementById("raceInfo");
      if (!el) return;

      const parts = [];
      const raceType = state?.race_type || state?.state?.race_type;
      if (raceType) parts.push(raceType.charAt(0).toUpperCase() + raceType.slice(1));

      const sessionLabel = state?.session_label || state?.state?.session_label;
      if (sessionLabel && sessionLabel !== "-") parts.push(sessionLabel);

      const limitStr = formatLimit(state?.limit);
      if (limitStr) parts.push(limitStr);

      el.textContent = parts.length ? parts.join(" â€¢ ") : "-";
    }

    function renderFlag(flag) {
      const host = document.getElementById("flagBanner");
      const lbl  = document.getElementById("flagLabel");
      if (!host || !lbl) return;

      const f = String(flag || "").toLowerCase();
      if (!f) {
        host.classList.add("d-none");
        lbl.textContent = "";
        return;
      }

      const text = FLAG_TITLES[f] || (f.charAt(0).toUpperCase() + f.slice(1));
      lbl.textContent = text;

      // Choose alert color by flag using Bootstrap only
      host.className = "alert py-2 mb-3";
      if (f === "green") host.classList.add("alert-success");
      else if (f === "yellow") host.classList.add("alert-warning");
      else if (f === "red") host.classList.add("alert-danger");
      else if (f === "checkered") host.classList.add("alert-info");
      else host.classList.add("alert-secondary");

      host.classList.remove("d-none");
    }

    function renderSim(sim, label) {
      const el = document.getElementById("simPill");
      if (!el) return;
      const on = (sim === true);
      if (on) {
        el.textContent = (label && String(label).trim().length) ? label : "SIMULATOR ACTIVE";
        el.title = el.textContent;
        el.classList.remove("d-none");
      } else {
        el.classList.add("d-none");
        el.textContent = "";
        el.removeAttribute("title");
      }
    }

    function extractRows(s){ return s?.standings ?? s?.entries ?? s?.rows ?? []; }

    function renderStandings(rows) {
      const tbody = document.getElementById("rows");
      if (!tbody) return;

      if (!Array.isArray(rows) || !rows.length) {
        tbody.innerHTML = "";
        return;
      }

      const displayRows = rows.slice(0, 16);
      tbody.innerHTML = "";

      for (let i = 0; i < displayRows.length; i++) {
        const r = displayRows[i];
        const pos = i + 1;

        const entrantId = Number(r.entrant_id);
        const car  = r.number ?? r.car ?? r.carNum ?? "";
        const name = r.name ?? r.team ?? r.driver ?? `Tag ${r.tag ?? ""}`;
        const laps = Number(r.laps ?? 0);

        const hasDetect = Number.isFinite(entrantId) && zeroLapDetections.has(entrantId);
        const showPlaceholder = (laps <= 0) && hasDetect;

        const last = showPlaceholder ? PRELAP_PLACEHOLDER : (typeof r.last === "number" ? fmtLapTime(r.last) : "-");
        const pace = showPlaceholder ? PRELAP_PLACEHOLDER : (typeof r.pace === "number" || typeof r.pace_5 === "number" ? fmtLapTime(r.pace || r.pace_5) : "-");
        const best = showPlaceholder ? PRELAP_PLACEHOLDER : (typeof r.best === "number" ? fmtLapTime(r.best) : "-");

        // New personal best highlight (only after lap 2)
        let hasNewBest = false;
        if (Number.isFinite(entrantId) && typeof r.best === "number" && r.best > 0 && laps > 2) {
          const prevBest = bestLapTracker.get(entrantId);
          if (prevBest === undefined || r.best < prevBest) {
            hasNewBest = true;
            bestLapTracker.set(entrantId, r.best);
          }
        } else if (Number.isFinite(entrantId) && typeof r.best === "number" && r.best > 0) {
          bestLapTracker.set(entrantId, r.best);
        }

        const tr = document.createElement("tr");
        if (hasNewBest && !showPlaceholder) {
          tr.classList.add("table-success");
          setTimeout(() => tr.classList.remove("table-success"), 1200);
        }

        tr.innerHTML = `
          <td>${pos}</td>
          <td>${car}</td>
          <td>${name}</td>
          <td class="text-start">${laps}</td>
          <td class="text-start font-monospace">${last}</td>
          <td class="text-start font-monospace">${pace}</td>
          <td class="text-start font-monospace">${best}</td>
        `;
        tbody.appendChild(tr);
      }
    }

    // Footer wall clock
    startWallClock("#wallClock");

    // Smooth race clock state
    let running = false;
    let lastSnapTime = 0;
    let lastClockMs  = 0;

    function renderClockTick(){
      let ms = lastClockMs;
      if (running) ms += (Date.now() - lastSnapTime);
      const el = document.getElementById("raceClock");
      if (el) el.textContent = fmtClock(ms);
    }

    // Poll /race/state at ~3 Hz and tick clock locally at 10 Hz
    const poller = makePoller(async () => {
      const s = await fetchJSON("/race/state");

      running      = !!s.running;
      lastClockMs  = s.clock_ms || 0;
      lastSnapTime = Date.now();

      const phaseLower = String(s.phase || "pre").toLowerCase();
      updateZeroLapDetections(s, phaseLower);

      renderRaceInfo(s);
      renderFlag(s.flag);
      renderStandings(extractRows(s));
      renderSim(s.sim, s.sim_label);

      const n = Array.isArray(s?.standings) ? Math.min(s.standings.length, 16) : 0;
      setNetStatus(true, `OK - ${n} karts`);
    }, 333, () => {
      setNetStatus(false, "Disconnected - retryingâ€¦");
    });
    poller.start();

    setInterval(renderClockTick, 100);
    renderClockTick();
  </script>
</body>
</html>
